<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		<title>30C3 map</title>
		<link rel="stylesheet" type="text/css" media="screen" href="leaflet/leaflet.css">
		<link rel="stylesheet" type="text/css" media="screen" href="bootstrap/css/bootstrap.min.css">
		<script type="text/javascript" src="jquery/jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="leaflet/leaflet.js"></script>
		<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript">
		
		//some Levenshtein-distnace code
		//http://www.merriampark.com/ld.htm, http://www.mgilleland.com/ld/ldjavascript.htm, Damerau–Levenshtein distance (Wikipedia)
			var levDist = function(s, t) {
			    var d = []; //2d matrix

			    // Step 1
			    var n = s.length;
			    var m = t.length;

			    if (n == 0) return m;
			    if (m == 0) return n;

			    //Create an array of arrays in javascript (a descending loop is quicker)
			    for (var i = n; i >= 0; i--) d[i] = [];

			    // Step 2
			    for (var i = n; i >= 0; i--) d[i][0] = i;
			    for (var j = m; j >= 0; j--) d[0][j] = j;

			    // Step 3
			    for (var i = 1; i <= n; i++) {
			        var s_i = s.charAt(i - 1);

			        // Step 4
			        for (var j = 1; j <= m; j++) {

			            //Check the jagged ld total so far
			            if (i == j && d[i][j] > 4) return n;

			            var t_j = t.charAt(j - 1);
			            var cost = (s_i == t_j) ? 0 : 1; // Step 5

			            //Calculate the minimum
			            var mi = d[i - 1][j] + 1;
			            var b = d[i][j - 1] + 1;
			            var c = d[i - 1][j - 1] + cost;

			            if (b < mi) mi = b;
			            if (c < mi) mi = c;

			            d[i][j] = mi; // Step 6

			            //Damerau transposition
			            if (i > 1 && j > 1 && s_i == t.charAt(j - 2) && s.charAt(i - 2) == t_j) {
			                d[i][j] = Math.min(d[i][j], d[i - 2][j - 2] + cost);
			            }
			        }
			    }

			    // Step 7
			    return d[n][m];
			}

			var things = {};
			things['Coffeenerds'] = [64.091,63.105];
			things['La Quadrature du Net'] = [60.63,45.791];
			things['Quality Alcohol'] = [56.17,-5.098];
			things['Villa Straylight'] = [55.628,11.162];
			things['Word-lounge'] = [27.45,-2.549];
			things['Kids'] = [26.981,27.51];
			things['Relax'] = [40.447,53.965];
			things['Hall 17'] = [54.214,47.373];
			things['Hall F'] = [11.006,-60.469];
			things['Hall E'] = [1.845,-61.172];
			things['Hall D'] = [-7.188,-61.084];
			things['Food-hacking'] = [2.021,-45.088];
			things['Gängeviertel'] = [-0.176,-26.279];
			things['Hall G'] = [10.833,-26.191];
			things['Speakers-corner'] = [-8.407,20.039];
			things['Full Circle'] = [-6.49,27.861];
			things['Chaoswelle'] = [2.899,46.758];
			things['Leiwandville'] = [-24.847,4.482];
			things['42'] = [-24.847,4.482];
			things['Civic Summit'] = [-22.837,4.395];
			things['Teckids'] = [-22.675,7.119];
			things['pyneo'] = [-22.269,9.58];
			things['irish'] = [-22.269,13.008];
			things['OSM'] = [-22.431,17.139];
			things['xenomorphs'] = [-24.287,9.229];
			things['fabhack'] = [-23.725,15.205];
			things['AKV'] = [-25.245,12.92];
			things['DFRi'] = [-25.165,15.996];
			things['Modern Poland'] = [-27.137,13.799];
			things['LÃ¼beck'] = [-27.684,2.549];
			things['Freifunk'] = [-29.535,2.549];
			things['Sendezentrum'] = [-33.358,4.307];
			things['Lockpicking'] = [-33.064,15.82];
			things['HacklabKiKa'] = [-33.651,23.643];
			things['Amsterdam'] = [-34.886,21.006];
			things['MW'] = [-35.102,25.313];
			things['Heaven'] = [-39.572,19.6];
			things['POC'] = [-28.382,29.355];
			things['linux call router'] = [-31.653,30.85];
			things['sigrok'] = [-31.728,34.453];
			things['C3S'] = [-28.15,37.617];
			things['#youbroketheinternet'] = [-27.45,40.078];
			things['WHS'] = [-25.879,39.639];
			things['HACAS'] = [-24.687,38.584];
			things['Cryptoparty'] = [-18.813,36.65];
			things['I2P'] = [-19.311,39.199];
			things['EFF'] = [-18.062,41.309];
			things['EDRi'] = [-16.383,45.527];
			things['FiFF'] = [-16.046,47.637];
			things['Noisy square'] = [-18.73,45.352];
			things['GSM'] = [-15.961,30.674];
			things['Hall 13'] = [-14.179,34.541];
			things['Hall 14'] = [-11.781,38.672];
			var locations = Object.keys(things);

			$(function () {
				var marker;
				var Icon = L.icon({
					iconUrl: 'leaflet/images/marker-icon-red.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41],
					shadowUrl: 'leaflet/images/marker-shadow.png'
				})

				var res = $('#result');
				var search = $('#search');
				function performSearch(){
					var searchstring = search.val().toLowerCase();
					var searchresult = locations.sort(function(a,b){
						return levDist(searchstring, a)
								- levDist(searchstring, b);
					});
					var html = '';
					for (var i = 0; i < Math.min(searchresult.length, 10); i++) {
						html += '<li>'+searchresult[i]+'</li>';
					}

					if (html != '') res.show();
						else res.hide();
					if (things[search]){
							addMarker(things[search]);
							$('#marker').addClass('active');
							setHash();
					}
					$('#result ul').html(html);
					$('#result ul li:first').addClass('selected');
					$('#result ul li').click(function(){select($(this).text())});
					res.css({top: search.position().top
								  + search.height() + 10,
							 left: search.position().left});
				}

				function select(text){					
					addMarker(things[text]);
					$('#marker').addClass('active');
					setHash();
					res.hide();
				}

				$('#search').keypress(function(e) {
					switch(e.keyCode) {
						case 13: // Enter
							var selected = $('#result ul li.selected').first();
							if (selected) selected.click();
							break;
				        default:
				        	performSearch();
					}
				});

				var map = L.map('map', {
					minZoom: 0,
					maxZoom: 6,
					zoom: 1,
					center: [0,0],
					maxBounds: [[-80,-180],[80,180]]
				});
				
				L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
				    attribution: '<a href="https://events.ccc.de/congress/2013/">30C3</a>',
				    noWrap: true
				}).addTo(map);

				$('#marker').on('click', function (event) {
					setTimeout(function () {
						var button = $(event.currentTarget);
						if (button.hasClass('active')) {
							addMarker();
						} else {
							removeMarker();
						}
					},0);
				})

				setTimeout(getHash, 0);

				function getHash() {
					var hash = window.location.hash;
					if (hash) {
						hash = hash.match(/([\-0-9]*)_([\-0-9]*)/);
						if (hash) {
							var pos = [
								parseInt(hash[1], 10)/1000,
								parseInt(hash[2], 10)/1000
							];
							addMarker(pos);
							$('#marker').addClass('active');
						}
					}
				}

				function addMarker(pos) {
					removeMarker();
					if (pos) {
						map.setView(pos, 3);
						marker = L.marker(pos, {
							icon: Icon
						});
						marker.addTo(map);
					} else {
						marker = L.marker(map.getCenter(), {
							draggable: true,
							opacity: 0.7,
							icon: Icon
						});
						marker.on('dragend', setHash);
						setHash();
						marker.addTo(map);
						$('#urlwrapper').addClass('visible');
					}
				}

				function removeMarker() {
					if (marker) {
						map.removeLayer(marker);
						marker = false;
						$('#urlwrapper').removeClass('visible');
						setHash();
					}
				}

				function setHash() {
					if (marker) {
						var pos = marker.getLatLng();
						pos = [
							(1000*pos.lat).toFixed(0),
							(1000*pos.lng).toFixed(0)
						].join('_');
						window.location.hash = pos;
						$('#url').val('http://michaelkreil.github.io/30c3-map/#'+pos);
					} else {
						window.location.hash = '';
					}
				}

				$('#url').on('click', function () {
					$('#url').select();
				})

			})
		</script>
		<style type="text/css">
			html, body, #map {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}
			#map {
				background: #fff
			}
			#marker {
				padding: 5px;
				position: absolute;
				top: 48px;
				right: 8px;
			}
			#marker-icon {
				width: 24px;
				height: 24px;
				background: url(leaflet/images/marker-icon-red.png) no-repeat;
				background-position: center;
				background-size: auto 100%;
			}
			.active #marker-icon {
				background-image: url(leaflet/images/marker-icon-grey.png);
			}
			#urlwrapper {
				display: none;
				position: absolute;
				left:8px;
				right:8px;
				bottom:8px;
				text-align: center;
			}
			#urlwrapper.visible {
				display: block;
			}
			#url {
				width: 100%;
				max-width: 500px
			}
			#search-wrapper {
				width: 50%;
				margin: 5px auto;
				border: pink;
				max-width: 500px
			}

			#search{
				width: 100%;
			}

			#result{
				display: none;
				margin: 0;
				padding: 0;
				z-index: 9999;
				position: absolute;
				width: 50%;
				max-width: 494px;
				border-radius: 5px;
				border: solid #CCC 2px;
			}

			#result ul li,
			#result ul {
				margin: 0;
				padding: 0 3px;
				background-color: #EEE;
				list-style:none;
				cursor: pointer;
				cursor: hand;
			}

			li.selected {
				font-weight: bold;
			}

		</style>
		<meta name="HandheldFriendly" content="True" />
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
	</head>
	<body>
		<div id="search-wrapper">
			<input id="search" type="text" />
		</div>
		<div id="result"><ul></ul></div>
		<div id="map">
		</div>
		<div id="marker" class="btn" data-toggle="button"><div id="marker-icon"></div></div>
		<div id="urlwrapper"><input type="text" id="url" /></div>
	</body>
</html>